Question,Difficulty,SQL
"Calculate the total general government revenue for Brazil in 2020 by aggregating state and local government revenues, expressed as a percent of GDP in billions",HARD,"SELECT 
    c.Country_Name,
    i.Indicator_Name,
    SUM(o.Value) AS Total_Revenue_Pct_GDP
FROM Observations o
JOIN Country c ON o.Country_ID = c.Country_ID
JOIN Sector s ON o.Sector_ID = s.Sector_ID
JOIN Indicator i ON o.Indicator_ID = i.Indicator_ID
JOIN Transformation t ON o.Transform_ID = t.Transform_ID
JOIN Scale sc ON o.Scale_ID = sc.Scale_ID
WHERE c.Country_Name = 'Brazil'
    AND o.Year = 2020
    AND s.Sector_Name IN ('State', 'Local')
    AND i.Indicator_Group = 'Revenue'
    AND t.Transform_Name = 'Percent of GDP'
    AND sc.Scale_Name = 'Billions'
GROUP BY c.Country_Name, i.Indicator_Name
HAVING COUNT(DISTINCT s.Sector_ID) = 2;"
"Show the year-over-year percentage change in net lending for Canada's general government from 2015 to 2022, identifying years with deficits greater than 3% of GDP",HARD,"WITH Yearly_Values AS (
    SELECT 
        o.Year,
        o.Value AS Current_Value,
        LAG(o.Value) OVER (ORDER BY o.Year) AS Previous_Value
    FROM Observations o
    JOIN Country c ON o.Country_ID = c.Country_ID
    JOIN Sector s ON o.Sector_ID = s.Sector_ID
    JOIN Indicator i ON o.Indicator_ID = i.Indicator_ID
    JOIN Transformation t ON o.Transform_ID = t.Transform_ID
    WHERE c.Country_Name = 'Canada'
        AND s.Sector_Name = 'General Government'
        AND i.Indicator_Name LIKE '%Net lending%'
        AND t.Transform_Name = 'Percent of GDP'
        AND o.Year BETWEEN 2015 AND 2022
)
SELECT 
    Year,
    Current_Value,
    Previous_Value,
    ((Current_Value - Previous_Value) / Previous_Value * 100) AS YoY_Change_Pct,
    CASE 
        WHEN Current_Value < -3 THEN 'High Deficit'
        ELSE 'Normal'
    END AS Deficit_Flag
FROM Yearly_Values
WHERE Previous_Value IS NOT NULL
ORDER BY Year;"
"Compare tax revenues as a percentage of GDP across G7 countries (Canada, France, Germany, Italy, Japan, United Kingdom, United States) for 2021, ranking them from highest to lowest and showing the difference from the G7 average.",HARD,"WITH G7_Tax_Revenue AS (
    SELECT 
        c.Country_Name,
        AVG(o.Value) AS Tax_Revenue_Pct_GDP
    FROM Observations o
    JOIN Country c ON o.Country_ID = c.Country_ID
    JOIN Sector s ON o.Sector_ID = s.Sector_ID
    JOIN Indicator i ON o.Indicator_ID = i.Indicator_ID
    JOIN Transformation t ON o.Transform_ID = t.Transform_ID
    WHERE c.Country_Name IN ('Canada', 'France', 'Germany', 'Italy', 'Japan', 'United Kingdom', 'United States')
        AND o.Year = 2021
        AND s.Sector_Name = 'General Government'
        AND i.Indicator_Name LIKE '%Tax%'
        AND t.Transform_Name = 'Percent of GDP'
    GROUP BY c.Country_Name
),
G7_Average AS (
    SELECT AVG(Tax_Revenue_Pct_GDP) AS Avg_Tax_Revenue
    FROM G7_Tax_Revenue
)
SELECT 
    g7.Country_Name,
    g7.Tax_Revenue_Pct_GDP,
    avg.Avg_Tax_Revenue AS G7_Average,
    (g7.Tax_Revenue_Pct_GDP - avg.Avg_Tax_Revenue) AS Difference_From_Avg
FROM G7_Tax_Revenue g7
CROSS JOIN G7_Average avg
ORDER BY g7.Tax_Revenue_Pct_GDP DESC;"
"For each year from 2018 to 2022, calculate the ratio of state government expenses to combined state and local expenses for the United States, showing only years where state expenses exceeded 60% of the combined total.",HARD,"SELECT 
    o.Year,
    SUM(CASE WHEN s.Sector_Name = 'State' THEN o.Value ELSE 0 END) AS State_Expenses,
    SUM(o.Value) AS Combined_State_Local_Expenses,
    (SUM(CASE WHEN s.Sector_Name = 'State' THEN o.Value ELSE 0 END) / SUM(o.Value) * 100) AS State_Pct_Of_Combined
FROM Observations o
JOIN Country c ON o.Country_ID = c.Country_ID
JOIN Sector s ON o.Sector_ID = s.Sector_ID
JOIN Indicator i ON o.Indicator_ID = i.Indicator_ID
JOIN Transformation t ON o.Transform_ID = t.Transform_ID
WHERE c.Country_Name = 'United States'
    AND s.Sector_Name IN ('State', 'Local')
    AND i.Indicator_Group = 'Expense'
    AND t.Transform_Name = 'Domestic currency'
    AND o.Year BETWEEN 2018 AND 2022
GROUP BY o.Year
HAVING (SUM(CASE WHEN s.Sector_Name = 'State' THEN o.Value ELSE 0 END) / SUM(o.Value) * 100) > 60
ORDER BY o.Year;"
"Identify countries where the debt-to-GDP ratio for general government increased by more than 10 percentage points between 2019 and 2021, and show how this compares to the sum of their state and local government debt ratios for the same period.",HARD,"WITH General_Govt_Debt AS (
    SELECT 
        c.Country_Name,
        SUM(CASE WHEN o.Year = 2019 THEN o.Value ELSE 0 END) AS Debt_2019,
        SUM(CASE WHEN o.Year = 2021 THEN o.Value ELSE 0 END) AS Debt_2021
    FROM Observations o
    JOIN Country c ON o.Country_ID = c.Country_ID
    JOIN Sector s ON o.Sector_ID = s.Sector_ID
    JOIN Indicator i ON o.Indicator_ID = i.Indicator_ID
    JOIN Transformation t ON o.Transform_ID = t.Transform_ID
    WHERE s.Sector_Name = 'General Government'
        AND i.Indicator_Name LIKE '%Debt%'
        AND t.Transform_Name = 'Percent of GDP'
        AND o.Year IN (2019, 2021)
    GROUP BY c.Country_Name
    HAVING (SUM(CASE WHEN o.Year = 2021 THEN o.Value ELSE 0 END) - 
            SUM(CASE WHEN o.Year = 2019 THEN o.Value ELSE 0 END)) > 10
),
Subnational_Debt AS (
    SELECT 
        c.Country_Name,
        SUM(CASE WHEN o.Year = 2019 THEN o.Value ELSE 0 END) AS Sub_Debt_2019,
        SUM(CASE WHEN o.Year = 2021 THEN o.Value ELSE 0 END) AS Sub_Debt_2021
    FROM Observations o
    JOIN Country c ON o.Country_ID = c.Country_ID
    JOIN Sector s ON o.Sector_ID = s.Sector_ID
    JOIN Indicator i ON o.Indicator_ID = i.Indicator_ID
    JOIN Transformation t ON o.Transform_ID = t.Transform_ID
    WHERE s.Sector_Name IN ('State', 'Local')
        AND i.Indicator_Name LIKE '%Debt%'
        AND t.Transform_Name = 'Percent of GDP'
        AND o.Year IN (2019, 2021)
    GROUP BY c.Country_Name
)
SELECT 
    gg.Country_Name,
    gg.Debt_2019 AS General_Govt_2019,
    gg.Debt_2021 AS General_Govt_2021,
    (gg.Debt_2021 - gg.Debt_2019) AS General_Govt_Change,
    COALESCE(sub.Sub_Debt_2019, 0) AS Subnational_2019,
    COALESCE(sub.Sub_Debt_2021, 0) AS Subnational_2021,
    (COALESCE(sub.Sub_Debt_2021, 0) - COALESCE(sub.Sub_Debt_2019, 0)) AS Subnational_Change
FROM General_Govt_Debt gg
LEFT JOIN Subnational_Debt sub ON gg.Country_Name = sub.Country_Name
ORDER BY (gg.Debt_2021 - gg.Debt_2019) DESC;"
,,
Country with the largest deterioration in overall cash balance during 2008–2009,HARD,"WITH balance AS (
    SELECT
        country_code,
        country_name,
        year,
        value AS cash_balance_pct_gdp
    FROM imf_gfs
    WHERE series_code = 'GNLB_Z'
      AND year IN (2008, 2009)
),
paired AS (
    SELECT
        b2008.country_name,
        (b2009.cash_balance_pct_gdp - b2008.cash_balance_pct_gdp) AS change_2009_minus_2008
    FROM balance b2008
    JOIN balance b2009
      ON b2008.country_code = b2009.country_code
     AND b2008.year = 2008
     AND b2009.year = 2009
)
SELECT
    country_name,
    change_2009_minus_2008
FROM paired
ORDER BY change_2009_minus_2008 ASC
LIMIT 1;"
Countries with high expenditure and low tax revenue (2010–2020),HARD,"WITH annual_pivot AS (
    SELECT
        country_code,
        country_name,
        year,
        SUM(CASE WHEN series_code = 'G11_Z' THEN value ELSE 0 END) AS tax_pct_gdp,
        SUM(CASE WHEN series_code = 'G2_Z'  THEN value ELSE 0 END) AS exp_pct_gdp
    FROM imf_gfs
    WHERE year BETWEEN 2010 AND 2020
    GROUP BY country_code, country_name, year
),
country_avgs AS (
    SELECT
        country_code,
        country_name,
        AVG(tax_pct_gdp) AS avg_tax_pct_gdp,
        AVG(exp_pct_gdp) AS avg_exp_pct_gdp
    FROM annual_pivot
    GROUP BY country_code, country_name
)
SELECT
    country_name,
    avg_tax_pct_gdp,
    avg_exp_pct_gdp
FROM country_avgs
WHERE avg_tax_pct_gdp < 15.0
  AND avg_exp_pct_gdp > 25.0
ORDER BY avg_exp_pct_gdp DESC;"
Country years with high unemployment and low social benefits (2005–2020),HARD,"WITH unemployment AS (
    SELECT
        d.country_code,
        d.country_name,
        d.year,
        AVG(d.value) AS unemployment_rate
    FROM gem_data d
    JOIN gem_series s
      ON d.series_code = s.series_code
    WHERE LOWER(s.series_name) LIKE '%unemployment%'
      AND d.year BETWEEN 2005 AND 2020
    GROUP BY d.country_code, d.country_name, d.year
),
social_benefits AS (
    SELECT
        country_code,
        country_name,
        year,
        SUM(value) AS social_benefits_pct_gdp
    FROM imf_gfs
    WHERE series_code = 'G27_Z'
      AND year BETWEEN 2005 AND 2020
    GROUP BY country_code, country_name, year
)
SELECT
    u.country_name,
    u.year,
    u.unemployment_rate,
    sb.social_benefits_pct_gdp
FROM unemployment u
JOIN social_benefits sb
  ON u.country_code = sb.country_code
 AND u.year = sb.year
WHERE u.unemployment_rate > 10
  AND sb.social_benefits_pct_gdp < 3
ORDER BY u.unemployment_rate DESC;"
"Combine IMF capital expenditure (% of GDP) with World Bank GDP growth data to determine which countries achieved the highest GDP growth per unit of public investment over 2010–2024.

Compute average GDP growth / average capital expenditure (% of GDP).
Rank countries descending by that ratio.",HARD,"WITH
-- IMF GFS: capital expenditure already expressed as % of GDP
gfs_capex_pct AS (
  SELECT
    d.country_iso3,
    CAST(g.`Time Period` AS UNSIGNED) AS year,
    CAST(g.`Value` AS DECIMAL(18,6))  AS capex_pct_gdp
  FROM imf_gfs_raw g
  JOIN country_name_to_iso3 d
    ON LOWER(TRIM(g.`Country`)) = LOWER(TRIM(d.country_name))
  WHERE g.`Frequency` = 'Annual'
    AND g.`Type of Transformation` = 'Percent of GDP'
    AND g.`GFS Indicator group` = 'Expenditure'
    AND g.`Indicator` REGEXP '(capital|gross[[:space:]]+capital[[:space:]]+formation|nonfinancial[[:space:]]+assets)'
    -- prefer general government if present; relax if your extract uses different labels
    AND g.`Sector` REGEXP '(general|total|consolidated|all)'
    AND CAST(g.`Time Period` AS UNSIGNED) BETWEEN 2010 AND 2024
),

-- World Bank GEM: GDP growth (annual %, constant prices)
gdp_growth AS (
  SELECT
    m.country_iso3,
    m.year,
    CAST(m.value AS DECIMAL(18,6)) AS gdp_growth_pct
  FROM wb_gem_macro m
  WHERE m.indicator_code = 'NY.GDP.MKTP.KD.ZG'  -- GDP growth (annual %)
    AND m.year BETWEEN 2010 AND 2024
),

-- Overlap years per country
joined AS (
  SELECT
    c.country_iso3,
    c.year,
    c.capex_pct_gdp,
    g.gdp_growth_pct
  FROM gfs_capex_pct c
  JOIN gdp_growth g
    ON g.country_iso3 = c.country_iso3
   AND g.year         = c.year
  WHERE c.capex_pct_gdp IS NOT NULL
    AND g.gdp_growth_pct IS NOT NULL
),

-- Country aggregates
agg AS (
  SELECT
    country_iso3,
    COUNT(*)                                        AS n_years,
    AVG(gdp_growth_pct)                             AS avg_gdp_growth_pct,
    AVG(capex_pct_gdp)                              AS avg_capex_pct_gdp,
    AVG(gdp_growth_pct) / NULLIF(AVG(capex_pct_gdp), 0) AS ratio_growth_per_capex
  FROM joined
  GROUP BY country_iso3
  HAVING COUNT(*) >= 5       -- require at least 5 overlapping years
     AND AVG(capex_pct_gdp) > 0
)

SELECT
  country_iso3,
  ROUND(ratio_growth_per_capex, 6)   AS ratio_growth_per_capex,
  ROUND(avg_gdp_growth_pct, 6)       AS avg_gdp_growth_pct,
  ROUND(avg_capex_pct_gdp, 6)        AS avg_capex_pct_gdp,
  n_years,
  RANK() OVER (ORDER BY ratio_growth_per_capex DESC) AS `rank`
FROM agg
ORDER BY `rank`;"
"Using GEM exports data (Exports Merchandise, current USD) and IMF GFS tax revenue data,
identify countries where export growth most strongly predicts revenue growth (2010–2024).

Regress Δ log(revenue) on Δ log(exports); rank by R².",HARD,"WITH
-- 1) IMF GFS: Tax revenue (Level, annual), aggregated per country-year
gfs_tax_revenue AS (
  SELECT
    d.country_iso3,
    CAST(g.`Time Period` AS UNSIGNED) AS year,
    SUM(CAST(g.`Value` AS DECIMAL(20,4))) AS tax_revenue
  FROM imf_gfs_raw g
  JOIN country_name_to_iso3 d
    ON LOWER(TRIM(g.`Country`)) = LOWER(TRIM(d.country_name))
  WHERE g.`Frequency` = 'Annual'
    AND g.`Type of Transformation` = 'Level'
    AND g.`GFS Indicator group` = 'Revenue'
    -- adjust this regex to match the wording of ""Tax revenue"" in your file
    AND g.`Indicator` REGEXP '(tax)'
    AND CAST(g.`Time Period` AS UNSIGNED) BETWEEN 2010 AND 2024
  GROUP BY d.country_iso3, CAST(g.`Time Period` AS UNSIGNED)
),

-- 2) GEM: Merchandise exports, current USD
gem_exports AS (
  SELECT
    m.country_iso3,
    m.year,
    CAST(m.value AS DECIMAL(20,4)) AS exports_usd
  FROM wb_gem_macro m
  WHERE m.year BETWEEN 2010 AND 2024
    -- TODO: replace 'EXPORTS_MERCH_USD' with your actual GEM indicator code
    AND m.indicator_code = 'EXPORTS_MERCH_USD'
),

-- 3) Join revenue + exports per country-year; keep positive values only (for logs)
joined_levels AS (
  SELECT
    r.country_iso3,
    r.year,
    r.tax_revenue,
    e.exports_usd
  FROM gfs_tax_revenue r
  JOIN gem_exports e
    ON e.country_iso3 = r.country_iso3
   AND e.year         = r.year
  WHERE r.tax_revenue  > 0
    AND e.exports_usd  > 0
),

-- 4) Compute log levels and Δ log (approx. growth rates) per country
log_deltas AS (
  SELECT
    country_iso3,
    year,
    LOG(tax_revenue)  AS log_rev,
    LOG(exports_usd)  AS log_exp,
    LOG(tax_revenue)
      - LAG(LOG(tax_revenue))  OVER (PARTITION BY country_iso3 ORDER BY year) AS dlog_rev,
    LOG(exports_usd)
      - LAG(LOG(exports_usd))  OVER (PARTITION BY country_iso3 ORDER BY year) AS dlog_exp
  FROM joined_levels
),

-- 5) Panel: keep years where both Δlog values exist
panel AS (
  SELECT
    country_iso3,
    year,
    dlog_rev AS y,
    dlog_exp AS x
  FROM log_deltas
  WHERE dlog_rev IS NOT NULL
    AND dlog_exp IS NOT NULL
),

-- 6) Per-country OLS stats (since MySQL doesn’t have REGR_* built in)
stats AS (
  SELECT
    country_iso3,
    COUNT(*)            AS n,
    SUM(x)              AS sumx,
    SUM(y)              AS sumy,
    SUM(x * x)          AS sumxx,
    SUM(y * y)          AS sumyy,
    SUM(x * y)          AS sumxy
  FROM panel
  GROUP BY country_iso3
  HAVING COUNT(*) >= 5        -- require at least 5 Δlog observations
),

-- 7) Compute β and R² from covariance/variance formulas
regression AS (
  SELECT
    country_iso3,
    n,
    (sumx / n)                       AS meanx,
    (sumy / n)                       AS meany,
    (sumxx / n) - POW(sumx / n, 2)   AS varx,
    (sumyy / n) - POW(sumy / n, 2)   AS vary,
    (sumxy / n) - (sumx / n) * (sumy / n) AS covxy
  FROM stats
),

scored AS (
  SELECT
    country_iso3,
    -- β (elasticity of revenue wrt exports): dlog_rev = α + β * dlog_exp
    covxy / NULLIF(varx, 0)                         AS beta,
    -- R² = cov² / (varx * vary)
    POW(covxy, 2) / NULLIF(varx * vary, 0)          AS r2
  FROM regression
  WHERE varx > 0 AND vary > 0
)

SELECT
  country_iso3,
  beta AS beta_dlog_exports_to_dlog_revenue,
  r2   AS explanatory_power_r2,
  RANK() OVER (ORDER BY r2 DESC) AS `rank`
FROM scored
ORDER BY `rank`;"
"Identify all years where countries experienced:

GDP growth < –2%, and

Expenditure (% of GDP) decreased simultaneously.

Count such “consolidation during recession” episodes per country.

Rank by frequency.",HARD,"WITH
-- 1) GDP growth (annual %, constant prices) from GEM
gdp_growth AS (
  SELECT
    m.country_iso3,
    m.year,
    CAST(m.value AS DECIMAL(10,4)) AS gdp_growth_pct
  FROM wb_gem_macro m
  WHERE m.indicator_code = 'NY.GDP.MKTP.KD.ZG'  -- GDP growth (annual %)
    AND m.year BETWEEN 2010 AND 2024
),

-- 2) IMF GFS: Expenditure (% of GDP), annual, general government
gfs_expenditure_pct AS (
  SELECT
    d.country_iso3,
    CAST(g.`Time Period` AS UNSIGNED) AS year,
    -- if there are multiple expenditure lines, sum them (or change this if you only want ""Total expenditure"")
    SUM(CAST(g.`Value` AS DECIMAL(18,6))) AS exp_pct_gdp
  FROM imf_gfs_raw g
  JOIN country_name_to_iso3 d
    ON LOWER(TRIM(g.`Country`)) = LOWER(TRIM(d.country_name))
  WHERE g.`Frequency` = 'Annual'
    AND g.`Type of Transformation` = 'Percent of GDP'
    AND g.`GFS Indicator group` = 'Expenditure'
    -- Adjust this if your Indicator column has a specific label like ""Expense"" or ""Total expenditure""
    AND g.`Indicator` REGEXP '(expenditure|expense)'
    -- General government / total sector; tweak if needed
    AND g.`Sector` REGEXP '(general|total|consolidated|all)'
    AND CAST(g.`Time Period` AS UNSIGNED) BETWEEN 2010 AND 2024
  GROUP BY d.country_iso3, CAST(g.`Time Period` AS UNSIGNED)
),

-- 3) Compute whether expenditure (% of GDP) decreased vs previous year
expenditure_change AS (
  SELECT
    country_iso3,
    year,
    exp_pct_gdp,
    LAG(exp_pct_gdp) OVER (PARTITION BY country_iso3 ORDER BY year) AS prev_exp_pct_gdp,
    CASE
      WHEN LAG(exp_pct_gdp) OVER (PARTITION BY country_iso3 ORDER BY year) IS NOT NULL
           AND exp_pct_gdp < LAG(exp_pct_gdp) OVER (PARTITION BY country_iso3 ORDER BY year)
      THEN 1 ELSE 0
    END AS exp_decreased
  FROM gfs_expenditure_pct
),

-- 4) Identify ""consolidation during recession"" episodes: GDP growth < -2% and exp_decreased = 1
episodes AS (
  SELECT
    e.country_iso3,
    e.year
  FROM expenditure_change e
  JOIN gdp_growth g
    ON g.country_iso3 = e.country_iso3
   AND g.year         = e.year
  WHERE g.gdp_growth_pct < -2.0
    AND e.exp_decreased = 1
),

-- 5) Count episodes per country
episode_counts AS (
  SELECT
    country_iso3,
    COUNT(*) AS num_episodes
  FROM episodes
  GROUP BY country_iso3
)

SELECT
  country_iso3,
  num_episodes,
  RANK() OVER (ORDER BY num_episodes DESC) AS `rank`
FROM episode_counts
ORDER BY `rank`;"
"Using IMF Total Expenditure (% of GDP) and GEM Inflation (CPI YoY):

Compute:

Exposure
=
Corr
(
Δ
Inflation
,
Δ
Expenditure
)
Exposure=Corr(ΔInflation,ΔExpenditure)

Rank descending.",Medium,"WITH
-- 1) IMF GFS: Total Expenditure (% of GDP), annual
gfs_expenditure_pct AS (
  SELECT
    d.country_iso3,
    CAST(g.`Time Period` AS UNSIGNED) AS year,
    SUM(CAST(g.`Value` AS DECIMAL(18,6))) AS exp_pct_gdp
  FROM imf_gfs_raw g
  JOIN country_name_to_iso3 d
    ON LOWER(TRIM(g.`Country`)) = LOWER(TRIM(d.country_name))
  WHERE g.`Frequency` = 'Annual'
    AND g.`Type of Transformation` = 'Percent of GDP'
    AND g.`GFS Indicator group` = 'Expenditure'
    -- adjust this if your Indicator has a specific label like 'Expense' or 'Total expenditure'
    AND g.`Indicator` REGEXP '(expenditure|expense)'
    -- general government / total sector; tweak if your extract uses different wording
    AND g.`Sector` REGEXP '(general|total|consolidated|all)'
    -- include 2009 so we can compute Δ for 2010
    AND CAST(g.`Time Period` AS UNSIGNED) BETWEEN 2009 AND 2024
  GROUP BY d.country_iso3, CAST(g.`Time Period` AS UNSIGNED)
),

-- 2) ΔExpenditure (% of GDP) per country-year
exp_deltas AS (
  SELECT
    country_iso3,
    year,
    exp_pct_gdp,
    exp_pct_gdp
      - LAG(exp_pct_gdp) OVER (PARTITION BY country_iso3 ORDER BY year) AS d_exp_pct
  FROM gfs_expenditure_pct
),

-- 3) GEM: CPI inflation (YoY, %) – replace indicator_code if needed
gem_inflation AS (
  SELECT
    m.country_iso3,
    m.year,
    CAST(m.value AS DECIMAL(18,6)) AS cpi_yoy
  FROM wb_gem_macro m
  WHERE m.indicator_code = 'FP.CPI.TOTL.ZG'  -- CPI inflation, YoY (%)
    AND m.year BETWEEN 2009 AND 2024
),

-- 4) ΔInflation per country-year
infl_deltas AS (
  SELECT
    country_iso3,
    year,
    cpi_yoy,
    cpi_yoy
      - LAG(cpi_yoy) OVER (PARTITION BY country_iso3 ORDER BY year) AS d_infl
  FROM gem_inflation
),

-- 5) Panel of overlapping ΔInflation and ΔExpenditure for 2010–2024
panel AS (
  SELECT
    e.country_iso3,
    e.year,
    i.d_infl AS x,        -- ΔInflation
    e.d_exp_pct AS y      -- ΔExpenditure (% of GDP)
  FROM exp_deltas e
  JOIN infl_deltas i
    ON i.country_iso3 = e.country_iso3
   AND i.year         = e.year
  WHERE e.year BETWEEN 2010 AND 2024
    AND i.d_infl   IS NOT NULL
    AND e.d_exp_pct IS NOT NULL
),

-- 6) Per-country summary stats for correlation calc
stats AS (
  SELECT
    country_iso3,
    COUNT(*)   AS n,
    SUM(x)     AS sumx,
    SUM(y)     AS sumy,
    SUM(x*x)   AS sumxx,
    SUM(y*y)   AS sumyy,
    SUM(x*y)   AS sumxy
  FROM panel
  GROUP BY country_iso3
  HAVING COUNT(*) >= 5   -- require at least 5 annual Δ pairs
),

-- 7) Compute covariance, variances, then correlation
corr_components AS (
  SELECT
    country_iso3,
    n,
    (sumx / n)                       AS meanx,
    (sumy / n)                       AS meany,
    (sumxx / n) - POW(sumx / n, 2)   AS varx,
    (sumyy / n) - POW(sumy / n, 2)   AS vary,
    (sumxy / n) - (sumx / n)*(sumy / n) AS covxy
  FROM stats
),

exposure AS (
  SELECT
    country_iso3,
    covxy / NULLIF(SQRT(varx * vary), 0) AS exposure_corr
  FROM corr_components
  WHERE varx > 0 AND vary > 0
)

SELECT
  country_iso3,
  exposure_corr AS exposure,
  RANK() OVER (ORDER BY exposure_corr DESC) AS `rank`
FROM exposure
ORDER BY `rank`;"