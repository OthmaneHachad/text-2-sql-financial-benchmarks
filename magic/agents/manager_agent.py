import sys
from pathlib import Path
sys.path.insert(0, str(Path(__file__).parent.parent.parent))

from together import Together
from magic.config import TEMPERATURE, MAX_TOKENS, BATCH_SIZE
from shared.config import TOGETHER_API_KEY, CURRENT_MODEL

class ManagerAgent:
    def __init__(self):
        self.client = Together(api_key=TOGETHER_API_KEY)
        self.model = CURRENT_MODEL
        self.correction_memory = []
        self.current_guideline = ""
        self.feedback_batch = []
        self.batch_size = BATCH_SIZE
    
    def compile_guideline(self, feedback_batch):
        """Generate or update self-correction guideline"""

        # Format feedback batch as per paper format
        feedback_text = "\n\n".join([
            f"Example {i+1}:\n"
            f"Question: {fb['question']}\n"
            f"Incorrect SQL: {fb['incorrect_sql']}\n"
            f"Corrected SQL: {fb['corrected_sql']}\n"
            f"Feedback: {fb['feedback']}"
            for i, fb in enumerate(feedback_batch)
        ])

        if not self.current_guideline:
            # Initial guideline generation (as per paper Figure 13)
            prompt = f"""# Guideline format:
number. Reminder of mistake
- Question: "Question"
- Incorrect SQL generated by me: ```sql incorrect sql ```
- Corrected SQL generated by me: ```sql corrected sql ```
- Negative and strict step-by-step ask-to-myself questions to prevent same mistake again:

# Guideline so far:
(empty - this is the first guideline)

# Recent mistakes that must be aggregate to Guideline:
{feedback_text}

# Updated Guideline (Return the entire guideline):"""
        else:
            # Update existing guideline (as per paper Figure 13)
            prompt = f"""# Guideline format:
number. Reminder of mistake
- Question: "Question"
- Incorrect SQL generated by me: ```sql incorrect sql ```
- Corrected SQL generated by me: ```sql corrected sql ```
- Negative and strict step-by-step ask-to-myself questions to prevent same mistake again:

# Guideline so far:
{self.current_guideline}

# Recent mistakes that must be aggregate to Guideline:
{feedback_text}

# Updated Guideline (Return the entire guideline):"""

        response = self.client.chat.completions.create(
            model=self.model,
            messages=[{"role": "user", "content": prompt}],
            temperature=TEMPERATURE["guideline"],
            max_tokens=MAX_TOKENS["guideline"]
        )

        self.current_guideline = response.choices[0].message.content
        usage = response.usage

        return self.current_guideline, usage.prompt_tokens, usage.completion_tokens